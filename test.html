<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Picker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #fff;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 4px solid #f3f3f3; 
            border-radius: 50%; 
            border-top: 4px solid #3498db; 
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
    <script>
        const DEVELOPER_KEY = 'AIzaSyBBtRX5-89QQrrT1rd3BDxKZwVFJ1ocvrw'; 
        const ACCESS_TOKEN = 'ya29.a0AW4XtxjPb-VI4KmnAw_VcxZ29bb-Z7ry0o1donKAV5jwpSsInFYoDGI3W8meYfmBzy5aquA25yxbxHU25GCyozkD_mDNB6nCVy1AGNXCIaeqEoqh9W5CwGJkW_nFlcgeZUW4Xjik4mrryHiCxfCBtRiE3beHkqeIThKn1NMoaCgYKAXsSARUSFQHGX2Mi42wVLibAV_BH3Zw4oDIkWA0175'; 
        const JS_CHANNEL = '{{DEFAULT_JS_CHANNEL}}';
        let access_token = null;
        let gapi_loaded = false;
        let picker_loaded = false;

        // Send a message back to Flutter
        function sendToFlutter(data) {
            if (window[JS_CHANNEL]) {
                try {
                    window[JS_CHANNEL].postMessage(JSON.stringify(data));
                } catch (e) {
                    console.error('Error sending to Flutter: ' + e);
                }
            }
        }


        // Define these functions before loading the scripts
        function onGapiLoad() {
            gapi_loaded = true;
            if (picker_loaded) {
                initializeApp();
            } 
        }

        function onPickerLoad() {
            picker_loaded = true;
            if (gapi_loaded) {
                initializeApp();
            }
        }

        function initializeApp() {
            initializeGAPI();
        }

        function initializeGAPI() {
            if (DEVELOPER_KEY.isEmpty || DEVELOPER_KEY === '{{DEVELOPER_KEY}}') {
                sendToFlutter({ action: 'error', message: 'Missing or invalid DEVELOPER_KEY' });
                return;
            }

            if (ACCESS_TOKEN.isEmpty || ACCESS_TOKEN === '{{ACCESS_TOKEN}}') {
                sendToFlutter({ action: 'error', message: 'Missing or invalid ACCESS_TOKEN' });
                return;
            }
            console.log('Google API initialized');
            access_token = ACCESS_TOKEN;
            openPicker();
        }

        function openPicker() {
            try {
                // Create a custom view for spreadsheets, CSV, and XLSX files
                const spreadsheetView = new google.picker.DocsView()
                    .setMimeTypes('application/vnd.google-apps.spreadsheet,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv')
                    .setMode(google.picker.DocsViewMode.LIST);
                
                // Create picker
                const picker = new google.picker.PickerBuilder()
                    .setDeveloperKey(DEVELOPER_KEY)
                    .setOAuthToken(access_token)
                    .addView(spreadsheetView)
                    .setTitle('Select a Spreadsheet')
                    .enableFeature(google.picker.Feature.NAV_HIDDEN)
                    .setCallback(pickerCallback)
                    .build();

                picker.setVisible(true);

            } catch (error) {
                sendToFlutter({ action: 'error', message: 'Picker error: ' + error });
            }
        }

        function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const file = data.docs[0];
                sendToFlutter({ action: 'picked', data: file, isLocalFile: false });
            } else if (data.action === google.picker.Action.CANCEL) {
                sendToFlutter({ action: 'canceled' });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const apiScript = document.createElement('script');
            const pickerScript = document.createElement('script');
            apiScript.src = 'https://apis.google.com/js/api.js';
            pickerScript.src = 'https://apis.google.com/js/picker.js';
            apiScript.onload = () => {
                gapi.load('picker', () => {
                    onGapiLoad();
                });
            };
            pickerScript.onload = () => {
                onPickerLoad();
            };
            document.head.appendChild(apiScript);
            document.head.appendChild(pickerScript);
        });

    </script>
</body>
</html>